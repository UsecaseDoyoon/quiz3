<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3번째 퀴즈</title>
    <style>
        /* 기존 스타일 유지 */
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            text-align: center;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background-image: url('aa.jpg');
            background-size: cover;
            background-position: center;
        }

        .background {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 92%;
            background-image: url('bb.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transform: translate(-50%, -50%);
            background-size: 100%;
        }

        #title {
    font-size: 43px;
    text-align: center;
    font-weight: 600;
        }

        #images {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-bottom: 20px;
            width: 100%;
        }

        .image {
            width: 20%;
            aspect-ratio: 1;
            margin: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            font-size: 2em;
            border-radius: 20px;
            background-color: white;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.336);
            margin-top: 10vh;
            flex-direction: column;
        }

        #icon-container img {
            width: 55%;
            height: 55%;
            object-fit: contain;
        }

        #speech-bubble {
            font-size: small;
            position: absolute;
            bottom: 100%;
            left: 22%;
            background-color: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 10vw;
            text-align: center;
            z-index: 10;
        }

        #speech-bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 0;
            border: 12px solid transparent;
            border-top-color: #ffffff;
            border-bottom: 0;
            border-left: 0;
            margin-left: -6px;
            margin-bottom: -12px;
        }

        #words {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            width: 100%;
            position: relative;
            border-radius: 15px;
            padding-top: 21vh;
            box-sizing: border-box;
            height: 20vh;
            width: 75vw;
            left: 3%;
            bottom: 6vh;
        }

        .word {
            padding: 12px;
            border: 1px solid #999999;
            cursor: pointer;
            position: relative;
            transition: opacity 0.2s;
            background-color: #ffffff;
            width: 10vw;
            border-radius: 15px;
            font-size: 5vh;
            font-weight: 400;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .bb {
            display: block;
            padding-bottom: 10px;
            width: 13%;
        }

        .correct {
            background-color: lightgreen;
        }

        .wrong {
            background-color: lightcoral;
        }

        .overlay {
            position: absolute;
            display: none;
            height: 22vh;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .xx {
            position: absolute;
            display: none;
            height: 18vh;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .one {
            max-height: 70%;
            max-width: 70%;
        }

        #icon-container {
            position: absolute;
            bottom: -15vh;
            left: -16%;
            width: 17vw;
            height: 40vh;
            z-index: 10;
        }

        #speech-bubble img {
            width: 8vw;
            height: 8vw;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 10px;
            padding-left: 1vw;
        }

        .jjum {
            display: block;
            margin-top: 10px;
            width: 10%;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
            z-index: 2;
            background-color: transparent;
        }

        .dimmed {
            opacity: 0.5;
            pointer-events: none;
        }

        .disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div class="background">
        <div id="title">Quiz 3. 그림을 보고 선을 그어 주세요.</div>
    
        <div id="images"> 
            <div id="A1" class="image" data-word="<?php echo $row['quiz3_answer1'] ?>">
                <img class="one" src="q1.png" style="width: 100%; height: 100%;"/>
                <img class="jjum" src="jjum.png">
                <img class="overlay" src="one.png">
                <img class="xx" src="xx.png">
            </div>
            <div id="A2" class="image" data-word="<?php echo $row['quiz3_answer2'] ?>">
                <img class="one" src="q2.png" style="width: 100%; height: 100%;"/>
                <img class="jjum" src="jjum.png">
                <img class="overlay" src="one.png">
                <img class="xx" src="xx.png">
            </div>
            <div id="A3" class="image" data-word="<?php echo $row['quiz3_answer3'] ?>">
                <img class="one" src="q3.png" style="width: 100%; height: 100%;"/>
                <img class="jjum" src="jjum.png">
                <img class="overlay" src="one.png">
                <img class="xx" src="xx.png">
            </div>
            <div id="A4" class="image" data-word="<?php echo $row['quiz3_answer4'] ?>">
                <img class="one" src="q4.png" style="width: 100%; height: 100%;"/>
                <img class="jjum" src="jjum.png">
                <img class="overlay" src="one.png">
                <img class="xx" src="xx.png">
            </div>
        </div>

        <div id="words-container">
            <div id="words">
                <div id="B1" class="word" data-word="<?php echo $row['quiz3_answer1'] ?>">
                    <img class="bb" src="jjum.png">
                    tree
                </div>
                <div id="B2" class="word" data-word="<?php echo $row['quiz3_answer2'] ?>">
                    <img class="bb" src="jjum.png">
                    apple
                </div>
                <div id="B3" class="word" data-word="<?php echo $row['quiz3_answer3'] ?>">
                    <img class="bb" src="jjum.png">
                    ship
                </div>
                <div id="B4" class="word" data-word="<?php echo $row['quiz3_answer4'] ?>">
                    <img class="bb" src="jjum.png">
                    plane
                </div>
            </div>
        </div>

        <div id="icon-container">
            <img src="pi2.png" alt="아이콘 이미지">
            <div id="speech-bubble">
                <div style="position: relative;">
                    <img id="mike-icon" src="a12.png" alt="아이콘 이미지" onclick="playSong()">
                    <img id="mike-icon-alt" src="2mike.png" alt="아이콘 이미지" style="display: none;" onclick="playSong()">
                </div>
            </div>
        </div>

        <audio id="audio-player" src="<?php echo $row['quiz3_sound'] ?>" preload="auto"></audio>
    </div>
    
    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let startX, startY, isDrawing = false;
        let lines = []; // 그려진 선을 저장
        let startElement = null; // 시작 요소
        let endElement = null;   // 종료 요소

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // 이벤트 핸들러 통합 함수
        function getCoordinates(event) {
            const rect = canvas.getBoundingClientRect();
            if (event.type.includes('touch')) {
                return {
                    x: event.touches[0].clientX - rect.left,
                    y: event.touches[0].clientY - rect.top
                };
            } else {
                return {
                    x: event.clientX - rect.left,
                    y: event.clientY - rect.top
                };
            }
        }

        function getEndCoordinates(event) {
            const rect = canvas.getBoundingClientRect();
            if (event.type.includes('touch')) {
                return {
                    x: event.changedTouches[0].clientX - rect.left,
                    y: event.changedTouches[0].clientY - rect.top
                };
            } else {
                return {
                    x: event.clientX - rect.left,
                    y: event.clientY - rect.top
                };
            }
        }

        // 선 그리기 시작
        function startDrawing(event) {
            const { x, y } = getCoordinates(event);
            startX = x;
            startY = y;
            isDrawing = true;

            const elements = document.elementsFromPoint(x + canvas.offsetLeft, y + canvas.offsetTop);
            startElement = elements.find(el => el.classList.contains('word') || el.classList.contains('image'));
            event.preventDefault();
        }

        // 선 그리기 진행중
        function draw(event) {
            if (!isDrawing) return;

            const { x, y } = getCoordinates(event);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            redraw();

            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(x, y);
            ctx.strokeStyle = '#FFE650';
            ctx.lineWidth = 2;
            ctx.stroke();

            drawDrop(startX, startY, '#FF6464');
            drawDrop(x, y, '#1E82FF');

            event.preventDefault();
        }

        // 선 그리기 종료
        function stopDrawing(event) {
            if (!isDrawing) return;

            const { x, y } = getEndCoordinates(event);
            isDrawing = false;

            const elements = document.elementsFromPoint(x + canvas.offsetLeft, y + canvas.offsetTop);
            endElement = elements.find(el => el.classList.contains('word') || el.classList.contains('image'));

            if (startElement && endElement) {
                const startWord = startElement.getAttribute('data-word');
                const endWord = endElement.getAttribute('data-word');

                if (startElement.classList.contains('word') && endElement.classList.contains('image')) {
                    if (startWord === endWord) {
                        lines.push({ startX, startY, endX: x, endY: y });
                        endElement.querySelector('.overlay').style.display = 'block';
                        startElement.classList.add('disabled');
                    } else {
                        endElement.querySelector('.xx').style.display = 'block';
                        startElement.classList.add('disabled');
                    }
                } else if (startElement.classList.contains('image') && endElement.classList.contains('word')) {
                    if (startWord === endWord) {
                        lines.push({ startX, startY, endX: x, endY: y });
                        startElement.querySelector('.overlay').style.display = 'block';
                        endElement.classList.add('disabled');
                    } else {
                        startElement.querySelector('.xx').style.display = 'block';
                        endElement.classList.add('disabled');
                    }
                }
            }

            redraw();
            startElement = null;
            endElement = null;
            event.preventDefault();
        }

        // 드롭 모양 그리기
        function drawDrop(x, y, color) {
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.bezierCurveTo(x + 10, y - 20, x - 10, y - 20, x, y);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.closePath();
        }

        // 저장된 선 다시 그리기
        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            lines.forEach(line => {
                ctx.beginPath();
                ctx.moveTo(line.startX, line.startY);
                ctx.lineTo(line.endX, line.endY);
                ctx.strokeStyle = '#FFE650';
                ctx.lineWidth = 2;
                ctx.stroke();
                drawDrop(line.startX, line.startY, '#FF6464');
                drawDrop(line.endX, line.endY, '#1E82FF');
            });
        }

        // 마우스 이벤트
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', () => isDrawing = false);

        // 터치 이벤트
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);

        // 오디오 재생
        function playSong() {
            const audioPlayer = document.getElementById('audio-player');
            const mikeIcon = document.getElementById('mike-icon');
            const mikeIconAlt = document.getElementById('mike-icon-alt');

            if (audioPlayer.paused) {
                audioPlayer.play();
                mikeIcon.style.display = 'none';
                mikeIconAlt.style.display = 'block';
            } else {
                audioPlayer.pause();
                mikeIcon.style.display = 'block';
                mikeIconAlt.style.display = 'none';
            }
        }

        // 창 크기 조정 시 캔버스 크기 업데이트
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            redraw();
        });
    </script>
</body>
</html>
